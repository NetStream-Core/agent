name: Snyk Security Scan
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
permissions:
  contents: read
  security-events: write
jobs:
  snyk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Generate Cargo.lock
        run: cargo generate-lockfile
      - name: Install Snyk CLI
        run: npm install -g snyk
      - name: Authenticate Snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk auth ${SNYK_TOKEN}
      - name: Run Snyk scan (Rust workspace)
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          set +e
          snyk test --file=agent/Cargo.toml \
            --severity-threshold=high \
            --sarif-file-output=snyk-agent.sarif \
            >/dev/null 2>&1
          snyk test --file=common/Cargo.toml \
            --severity-threshold=high \
            --sarif-file-output=snyk-common.sarif \
            >/dev/null 2>&1
          EMPTY_SARIF='{
            "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
            "version": "2.1.0",
            "runs": [
              {
                "tool": {
                  "driver": {
                    "name": "Snyk",
                    "semanticVersion": "0.0.0",
                    "rules": []
                  }
                },
                "results": []
              }
            ]
          }'
          for file in snyk-agent.sarif snyk-common.sarif; do
            if ! jq -e . "$file" >/dev/null 2>&1; then
              echo "$EMPTY_SARIF" > "$file"
            fi
          done
      - name: Upload SARIF for agent to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: snyk-agent.sarif
          category: snyk/agent
      - name: Upload SARIF for common to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: snyk-common.sarif
          category: snyk/common
