name: Snyk Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write

jobs:
  snyk:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install Snyk CLI
        run: npm install -g snyk

      - name: Authenticate Snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk auth ${SNYK_TOKEN}

      - name: Run Snyk scan for Rust workspace
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          set -e

          snyk test agent \
            --file=agent/Cargo.toml \
            --severity-threshold=high \
            --sarif-file-output=snyk-agent.sarif || echo "Snyk agent scan failed"

          snyk test common \
            --file=common/Cargo.toml \
            --severity-threshold=high \
            --sarif-file-output=snyk-common.sarif || echo "Snyk common scan failed"

          if [ ! -f snyk-agent.sarif ]; then
            echo '{"$schema":"https://json.schemastore.org/sarif-2.1.0","version":"2.1.0","runs":[]}' > snyk-agent.sarif
          fi

          if [ ! -f snyk-common.sarif ]; then
            echo '{"$schema":"https://json.schemastore.org/sarif-2.1.0","version":"2.1.0","runs":[]}' > snyk-common.sarif
          fi

          jq -s '
            {
              "$schema": "https://json.schemastore.org/sarif-2.1.0",
              "version": "2.1.0",
              "runs": (.[].runs)
            }
          ' snyk-agent.sarif snyk-common.sarif > snyk.sarif

      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: snyk.sarif
